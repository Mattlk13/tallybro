window.App={Models:{},Collections:{},Views:{}},App.Views.AppView=Backbone.View.extend({el:$("#root"),initialize:function(){this.listenTo(App.players,"add",this.addOne),this.listenTo(App.players,"reset",this.addAll),App.players.fetch()},addOne:function(e){var t=new App.Views.PlayerView({model:e});this.$("#players").append(t.render().el)},addAll:function(){App.players.each(this.addOne,this)}}),$(function(){App.players=new App.Collections.PlayerCollection,App.new_player_view=new App.Views.NewPlayerView,App.tallyBro=new App.Views.AppView}),App.Views.NewPlayerView=Backbone.View.extend({el:$("#new-player"),events:{"dragover .headshot":"dragOver","dragleave .headshot":"dragEnd","drop .headshot":"drop",submit:"createPlayer"},dragOver:function(e){return $(e.target).addClass("hover"),!1},dragEnd:function(e){return $(e.target).removeClass("hover"),!1},drop:function(e){e.preventDefault(),$(e.target).removeClass("hover"),this.readFiles(e.originalEvent.dataTransfer.files)},readFiles:function(e){for(var t=new FormData,n=0,r=e.length;r>n;n++)t.append("file",e[n]),this.previewFile(e[n])},previewFile:function(e){var t=new FileReader,n=this;t.onload=function(e){var t=new Image;t.src=e.target.result,n.$el.find(".headshot").html(t),n.$el.find("input[name=headshot]").val(t.src)},t.readAsDataURL(e)},createPlayer:function(e){e.preventDefault(),App.players.create($(e.target).serializeObject()),e.target.reset(),this.$el.find(".headshot").html("Drop photo")}}),App.Collections.PlayerCollection=Backbone.Collection.extend({model:App.Models.Player,localStorage:new Backbone.LocalStorage("players")}),App.Models.Player=Backbone.Model.extend({defaults:{headshot:"",name:"",points:0}}),App.Views.PlayerView=Backbone.View.extend({className:"span3 player",template:_.template($("#tmpl-player").html()),events:{"click .controls a":"updatePoints","click .remove":"clear"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},clear:function(e){e.preventDefault();var t=confirm("Are you sure you want to remove "+this.model.get("name"));t&&this.model.destroy()},animateProgressBar:function(){var e=this.$el.find(".indicator .progress");e.stop(!0,!0).animate({width:"100%"},2e3,"linear",function(){e.css({width:0})})},updateTotal:function(e){var t=+this.$el.find(".current").html(),n=t+ +e;this.$el.find(".current").html(n),this.$el.find(".change-by").empty(),this.model.save({points:n})},updatePoints:function(e){var t=this.$el.find(".change-by"),n=+t.html(),r=1,i="subtract",o=this;e.preventDefault(),$(e.target).hasClass("subtract")&&(r=-1),n+=r,n>=0&&(n="+"+n,i="add"),t.html(n).removeClass("add subtract").addClass(i),clearTimeout(this.timeout),this.timeout=setTimeout(function(){o.updateTotal(n)},2e3),this.animateProgressBar()}});